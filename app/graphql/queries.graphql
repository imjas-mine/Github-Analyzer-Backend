# ============================================
# Query 1: Fetch all repositories for a user (Timeline View)
# Use this to display the repo list/timeline
# ============================================
query GetUserRepositories($username: String!, $first: Int = 100, $after: String) {
    user(login: $username) {
        login
        avatarUrl
        repositories(first: $first, after: $after, orderBy: {field: UPDATED_AT, direction: DESC}, ownerAffiliations: [OWNER, COLLABORATOR, ORGANIZATION_MEMBER]) {
            totalCount
            pageInfo {
                hasNextPage
                endCursor
            }
            nodes {
                name
                nameWithOwner
                description
                url
                isPrivate
                isFork
                stargazerCount
                forkCount
                primaryLanguage {
                    name
                    color
                }
                createdAt
                updatedAt
                pushedAt
                # Check if user is owner or contributor
                owner {
                    login
                }
                # Get user's contribution count to this repo
                defaultBranchRef {
                    name
                    target {
                        ... on Commit {
                            history(first: 1, author: {id: null}) {
                                totalCount
                            }
                        }
                    }
                }
            }
        }
    }
}

# ============================================
# Query 2: Detailed Repository Info (Single Repo View)
# Fetches comprehensive data for AI analysis
# ============================================
query GetRepositoryDetails($owner: String!, $name: String!, $username: String!) {
    repository(owner: $owner, name: $name) {
        # Basic Info
        name
        nameWithOwner
        description
        url
        homepageUrl
        isPrivate
        isFork
        isArchived
        isTemplate
        
        # Stats
        stargazerCount
        forkCount
        watchers {
            totalCount
        }
        
        # Dates
        createdAt
        updatedAt
        pushedAt
        
        # Owner info (to determine if user owns or contributed)
        owner {
            login
            avatarUrl
        }
        
        # Languages (for framework detection)
        languages(first: 10, orderBy: {field: SIZE, direction: DESC}) {
            totalCount
            totalSize
            edges {
                size
                node {
                    name
                    color
                }
            }
        }
        
        # Primary Language
        primaryLanguage {
            name
            color
        }
        
        # Topics/Tags (helps identify project type)
        repositoryTopics(first: 20) {
            nodes {
                topic {
                    name
                }
            }
        }
        
        # Default branch info
        defaultBranchRef {
            name
            target {
                ... on Commit {
                    # Total commits in repo
                    history(first: 1) {
                        totalCount
                    }
                }
            }
        }
        
        # README content (for AI summary if no description)
        object(expression: "HEAD:README.md") {
            ... on Blob {
                text
            }
        }
        
        # Check for common config files to detect frameworks
        # Package.json (Node.js/React/Vue/Angular)
        packageJson: object(expression: "HEAD:package.json") {
            ... on Blob {
                text
            }
        }
        
        # Requirements.txt (Python)
        requirementsTxt: object(expression: "HEAD:requirements.txt") {
            ... on Blob {
                text
            }
        }
        
        # Pyproject.toml (Modern Python)
        pyprojectToml: object(expression: "HEAD:pyproject.toml") {
            ... on Blob {
                text
            }
        }
        
        # Cargo.toml (Rust)
        cargoToml: object(expression: "HEAD:Cargo.toml") {
            ... on Blob {
                text
            }
        }
        
        # Pom.xml (Java/Maven)
        pomXml: object(expression: "HEAD:pom.xml") {
            ... on Blob {
                text
            }
        }
        
        # Build.gradle (Java/Kotlin Gradle)
        buildGradle: object(expression: "HEAD:build.gradle") {
            ... on Blob {
                text
            }
        }
        
        # Go.mod (Go)
        goMod: object(expression: "HEAD:go.mod") {
            ... on Blob {
                text
            }
        }
        
        # Gemfile (Ruby)
        gemfile: object(expression: "HEAD:Gemfile") {
            ... on Blob {
                text
            }
        }
        
        # Composer.json (PHP)
        composerJson: object(expression: "HEAD:composer.json") {
            ... on Blob {
                text
            }
        }
        
        # Pubspec.yaml (Dart/Flutter)
        pubspecYaml: object(expression: "HEAD:pubspec.yaml") {
            ... on Blob {
                text
            }
        }
        
        # Docker (indicates deployment setup)
        dockerfile: object(expression: "HEAD:Dockerfile") {
            ... on Blob {
                text
            }
        }
        
        # Root directory structure (to understand project layout)
        rootTree: object(expression: "HEAD:") {
            ... on Tree {
                entries {
                    name
                    type
                }
            }
        }
    }
}

# ============================================
# Query 3: User's Contributions to a Specific Repo
# Fetches commits, PRs, and issues by the user
# ============================================
query GetUserContributions($owner: String!, $name: String!, $username: String!, $authorId: ID) {
    repository(owner: $owner, name: $name) {
        name
        
        # User's commits (needs author ID, fallback to fetching recent)
        defaultBranchRef {
            target {
                ... on Commit {
                    history(first: 100, author: {id: $authorId}) {
                        totalCount
                        nodes {
                            message
                            committedDate
                            additions
                            deletions
                            changedFilesIfAvailable
                            author {
                                name
                                email
                                user {
                                    login
                                }
                            }
                        }
                    }
                }
            }
        }
        
        # PRs by the user
        pullRequests(first: 50, states: [OPEN, CLOSED, MERGED], orderBy: {field: CREATED_AT, direction: DESC}) {
            totalCount
            nodes {
                title
                state
                createdAt
                mergedAt
                closedAt
                additions
                deletions
                changedFiles
                author {
                    login
                }
            }
        }
        
        # Issues created by user
        issues(first: 50, states: [OPEN, CLOSED], orderBy: {field: CREATED_AT, direction: DESC}) {
            totalCount
            nodes {
                title
                state
                createdAt
                closedAt
                author {
                    login
                }
                labels(first: 5) {
                    nodes {
                        name
                        color
                    }
                }
            }
        }
    }
}

# ============================================
# Query 4: Get User ID (needed for filtering commits by author)
# ============================================
query GetUserId($username: String!) {
    user(login: $username) {
        id
        login
        name
        avatarUrl
        bio
        company
        location
        email
        websiteUrl
        createdAt
        followers {
            totalCount
        }
        following {
            totalCount
        }
        repositories {
            totalCount
        }
        contributionsCollection {
            totalCommitContributions
            totalPullRequestContributions
            totalIssueContributions
            totalRepositoryContributions
            contributionCalendar {
                totalContributions
            }
        }
    }
}

# ============================================
# Query 5: Contribution stats for a specific repo by user
# Lightweight query to check user's involvement
# ============================================
query GetUserRepoContributionStats($owner: String!, $name: String!, $username: String!) {
    repository(owner: $owner, name: $name) {
        name
        owner {
            login
        }
        # Check if user is a collaborator
        collaborators(first: 1, query: $username) {
            nodes {
                login
            }
        }
        # Recent commits to check user involvement
        defaultBranchRef {
            target {
                ... on Commit {
                    history(first: 100) {
                        nodes {
                            author {
                                user {
                                    login
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

# ============================================
# Query 6: Fetch specific file content
# Use when you need to read a specific file for analysis
# ============================================
query GetFileContent($owner: String!, $name: String!, $expression: String!) {
    repository(owner: $owner, name: $name) {
        object(expression: $expression) {
            ... on Blob {
                text
                byteSize
            }
        }
    }
}

# ============================================
# Query 7: Get directory tree (for project structure analysis)
# ============================================
query GetDirectoryTree($owner: String!, $name: String!, $expression: String!) {
    repository(owner: $owner, name: $name) {
        object(expression: $expression) {
            ... on Tree {
                entries {
                    name
                    type
                    object {
                        ... on Blob {
                            byteSize
                        }
                        ... on Tree {
                            entries {
                                name
                                type
                            }
                        }
                    }
                }
            }
        }
    }
}